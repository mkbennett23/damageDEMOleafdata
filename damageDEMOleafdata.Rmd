---
title: "damageDEMOleafdata"
author: "Shelley Bennett"
date: "3/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages
```{r}
library(nlme)
library(emmeans)
library(performance)
library(tidyverse)
library(codyn)
library(lme4)
library(pscl)
library(effects)
library(glmmTMB)
library(car) #Anova test for mixed models, for this code of the genpois model form glmmTMB
library(DHARMa)

```


```{r}
setwd("~/Dropbox (Smithsonian)/SERC_damageDEMO") #shelley
```


Random stuff that I need
```{r}
#run this for sum of squares
options(contrasts=c('contr.sum','contr.poly')) #run this first, important to make sure your sum of squares work right

##function for making graphs with summary statistics
barGraphStats <- function(data, variable, byFactorNames) {
  count <- length(byFactorNames)
  N <- aggregate(data[[variable]], data[byFactorNames], FUN=length)
  names(N)[1:count] <- byFactorNames
  names(N) <- sub("^x$", "N", names(N))
  mean <- aggregate(data[[variable]], data[byFactorNames], FUN=mean)
  names(mean)[1:count] <- byFactorNames
  names(mean) <- sub("^x$", "mean", names(mean))
  sd <- aggregate(data[[variable]], data[byFactorNames], FUN=sd)
  names(sd)[1:count] <- byFactorNames
  names(sd) <- sub("^x$", "sd", names(sd))
  preSummaryStats <- merge(N, mean, by=byFactorNames)
  finalSummaryStats <- merge(preSummaryStats, sd, by=byFactorNames)
  finalSummaryStats$se <- finalSummaryStats$sd / sqrt(finalSummaryStats$N)
  return(finalSummaryStats)
}  
```

load data
```{r}
damage <- read.csv("~/Dropbox (Smithsonian)/SERC_damageDemo/damage_2021_combined.csv")
plots <- read.csv("~/Dropbox (Smithsonian)/SERC_damageDemo/damagedemoplots.csv")
treenum <- read.csv("~/Dropbox (Smithsonian)/SERC_damageDemo/treenum.csv")
```
Amy load data
```{r}

setwd("C:/Users/hrusk/Dropbox (Smithsonian)/SERC_damageDEMO")
damage <- read.csv("damage_2021_combined2.csv")
plots <- read.csv("damagedemoplots2.csv")

```

merge data
```{r}
#merge dataframes
damagePlots <- damage %>%
  merge(plots, by = "Plot")
  #merge(treenum, by = "Tree_num")

damageMature <- damagePlots %>%
  filter(Age_class == "Mature")

damageSapling <- damagePlots %>%
  filter(Age_class == "Sapling")
```

stuff that is wrong or doesn't work
```{r}
#tried running an ANOVA without repeated measures
summary(insectherbModel <- aov(Percent_total_herbivory~as.factor(Species)*as.factor(Age_class)*as.factor(plot_age_class)*as.factor(Sample_period), data=damage1))
anova(insectherbModel)


#this is the model we want but doesn't currently run
summary(insectherbModel <- lme(Percent_total_herbivory~as.factor(Species)*as.factor(Age_class)*as.factor(plot_age_class), data=damage1, random=~1|uniqueplant_num, correlation=corCompSymm(form=~1|uniqueplant_num), control=lmeControl(returnObject = T)))
##this model doesn't work because we included plot age class in the fixed effects and there aren't all interactions in all plot age classes (i.e not all species at each plant age class in all plot age classes)

##trying again with nesting
summary(insectherbModel <- lme(Percent_total_herbivory~as.factor(Species)*as.factor(Age_class)*as.factor(plot_age_class), data=damage1, random=~1|plot_age_class/Plot/Age_class/Tree_num, correlation=corCompSymm(form=~1|plot_age_class/Plot/Tree_num), control=lmeControl(returnObject = T)))
```


######Total Percent Herbivory Model######

Model 1: Sample period 1 (July), all life stages; using damageJuly
Model 2: Sample period 2(Oct), just sapling and mature; using damageOct
**no sample period as variable in models anymore**

getting data into correct form, making data frames for each model
```{r}
damagePlots$Species <- as.factor(damagePlots$Species)
damagePlots$Age_class <- as.factor(damagePlots$Age_class)
damagePlots$Sample_period <- as.factor(damagePlots$Sample_period)
damagePlots$Percent_total_herbivory <- as.integer(as.numeric(damagePlots$Percent_total_herbivory))

#filter for all life stages at sample period 1
damageJuly <- damagePlots %>%
  filter(Sample_period == 1)

#filter for only sapling and mature, sample period 2
damageOct <- damagePlots %>%
  filter(Age_class == "Sapling" | Age_class == "Mature")%>%
  filter(Sample_period == 2)

damageOct$Age_class <- factor(damageOct$Age_class, levels = c("Sapling", "Mature"))
damageJuly$Age_class <- factor(damageJuly$Age_class, levels = c("Seedling", "Sapling", "Mature"))

#summary(insectherbModel <- lme(Percent_total_herbivory~Species*Age_class*Sample_period, data=damage1, random=~1|plot_age_class/Plot/Tree_num, correlation=corCompSymm(form=~1|plot_age_class/Plot/Tree_num), control=lmeControl(returnObject = T)))

#anova.lme(insectherbModel, type = 'sequential')
#emmeans(insectherbModel, pairwise~as.factor(Species)*as.factor(Age_class), adjust="tukey")
```

looking at above model
```{r}
plot(allEffects(insectherbModel))
```

checking data
```{r}
hist(damagePlots$Percent_total_herbivory)
qqnorm(damagePlots$Percent_total_herbivory)
```


overdispersion function
```{r}
overdisp_fun <- function(insectherbModel) {
     rdf <- df.residual(insectherbModel)
     rp <- residuals(insectherbModel,type="pearson")
     Pearson.chisq <- sum(rp^2)
     prat <- Pearson.chisq/rdf
     pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
     c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)}

overdisp_fun(insectherbModel)

```


model to account for overdispersion/non-nomral distribution
doesn't work for Shelley, need "OpenMP"

**Model 2** -- Amy please rerun with new code using damagedOct instead of damage1
```{r}

#insectherbModeloverdisp <-glmmTMB(Percent_total_herbivory~ Species*Age_class*Sample_period+(1|plot_age_class/Plot/Tree_num), data = damage1, family = genpois)

insectherbModeloverdisp <-glmmTMB(Percent_total_herbivory~ Species*Age_class+(1|plot_age_class/Plot/Tree_num), data = damageOct, family = genpois)

##model checking##
model_check <- simulateResiduals(insectherbModeloverdisp)
plot(model_check)

#Amy also ran...#
testZeroInflation(insectherbModeloverdisp) #not significant, good
testUniformity(insectherbModeloverdisp) #not significant, good
testOutliers(insectherbModeloverdisp) #not significant, good

drop1(insectherbModeloverdisp, test = 'Chisq') #preferred way to test model, but doesn't look at main effects

#Model output:
#Single term deletions

#Model:
#Percent_total_herbivory ~ Species * Age_class + (1 | plot_age_class/Plot/Tree_num)
#                  Df   AIC   LRT Pr(>Chi)  
#<none>               10617                 
#Species:Age_class  2 10618 4.654  0.09759 .
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Anova(insectherbModeloverdisp) #Wald's test not prefferred for model type, but gives main effects

#Analysis of Deviance Table (Type II Wald chisquare tests)

#Response: Percent_total_herbivory
                    Chisq Df Pr(>Chisq)    
#Species           80.2641  2    < 2e-16 ***
#Age_class          0.7174  1    0.39701    
#Species:Age_class  4.6923  2    0.09574 .  
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1



emmeans(insectherbModeloverdisp, pairwise~as.factor(Species)*as.factor(Age_class), adjust="tukey")



```



Show in New Window
Linear mixed-effects model fit by REML
  Data: damage1 

Random effects:
 Formula: ~1 | plot_age_class
        (Intercept)
StdDev:   0.2584916

 Formula: ~1 | Plot %in% plot_age_class
        (Intercept)
StdDev:   0.6156307

 Formula: ~1 | Tree_num %in% Plot %in% plot_age_class
        (Intercept) Residual
StdDev:    1.205405 5.527392

Correlation Structure: Compound symmetry
 Formula: ~1 | plot_age_class/Plot/Tree_num 
 Parameter estimate(s):
          Rho 
-4.180851e-05 
Fixed effects:  Percent_total_herbivory ~ Species * Age_class * Sample_period 
 Correlation: 
                                  (Intr) Specs1 Specs2 Ag_cl1
Species1                          -0.600                     
Species2                          -0.621  0.368              
Age_class1                         0.694 -0.661 -0.614       
Sample_period                     -0.837  0.588  0.602 -0.676
Species1:Age_class1               -0.620  0.582  0.550 -0.654
Species2:Age_class1               -0.572  0.542  0.644 -0.669
Species1:Sample_period             0.548 -0.899 -0.347  0.604
Species2:Sample_period             0.562 -0.345 -0.899  0.558
Age_class1:Sample_period          -0.625  0.599  0.554 -0.904
Species1:Age_class1:Sample_period  0.560 -0.528 -0.496  0.592
Species2:Age_class1:Sample_period  0.516 -0.497 -0.576  0.607
                                  Smpl_p Sp1:A_1 Sp2:A_1 Sp1:S_
Species1                                                       
Species2                                                       
Age_class1                                                     
Sample_period                                                  
Species1:Age_class1                0.604                       
Species2:Age_class1                0.557  0.386                
Species1:Sample_period            -0.656 -0.531  -0.499        
Species2:Sample_period            -0.671 -0.500  -0.580   0.387
Age_class1:Sample_period           0.747  0.592   0.606  -0.667
Species1:Age_class1:Sample_period -0.667 -0.906  -0.349   0.588
Species2:Age_class1:Sample_period -0.616 -0.348  -0.904   0.552
                                  Sp2:S_ A_1:S_ S1:A_1:
Species1                                               
Species2                                               
Age_class1                                             
Sample_period                                          
Species1:Age_class1                                    
Species2:Age_class1                                    
Species1:Sample_period                                 
Species2:Sample_period                                 
Age_class1:Sample_period          -0.616               
Species1:Age_class1:Sample_period  0.552 -0.656        
Species2:Age_class1:Sample_period  0.642 -0.671  0.387 

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-1.55369007 -0.41876288 -0.24152993  0.01138407 11.21226404 

Number of Observations: 5556
Number of Groups: 
                        plot_age_class 
                                     6 
              Plot %in% plot_age_class 
                                    18 
Tree_num %in% Plot %in% plot_age_class 
                                   301 
R Console
Description:df [1 x 3]
 
 
AIC
<dbl>
BIC
<dbl>
logLik
<dbl>
35013.56	35126.11	-17489.78	
1 row
data.frame
1 x 3
Description:df [12 x 5]
 
 
Value
<chr>
(Intercept)	1.0286782	
Species1	2.1274683	
Species2	-0.5059876	
Age_class1	-0.6026049	
Sample_period	1.0662498	
Species1:Age_class1	0.5772445	
Species2:Age_class1	0.4892877	
Species1:Sample_period	-1.2620303	
Species2:Sample_period	-0.1137064	
Age_class1:Sample_period	0.2803926	
1-10 of 12 rows | 1-2 of 5 columns
data.frame
12 x 5
Description:df [12 x 5]
 
 
Value
<chr>
Std.Error
<chr>
DF
<chr>
(Intercept)	1.0286782	0.4828562	5245	
Species1	2.1274683	0.5062100	5245	
Species2	-0.5059876	0.5033387	5245	
Age_class1	-0.6026049	0.4469863	282	
Sample_period	1.0662498	0.2695001	5245	
Species1:Age_class1	0.5772445	0.5026265	5245	
Species2:Age_class1	0.4892877	0.5005708	5245	
Species1:Sample_period	-1.2620303	0.3029511	5245	
Species2:Sample_period	-0.1137064	0.3013717	5245	
Age_class1:Sample_period	0.2803926	0.2695033	5245	
1-10 of 12 rows | 1-4 of 5 columns
Show in New Window
Error in pchisq(Pearson.chisq, df = rdf, lower.tail = FALSE) : Non-numeric argument to mathematical function
Show in New Window
$emmeans
 Species      Age_class emmean    SE   df lower.CL upper.CL
 Beech        Sapling    0.601 0.126 2783    0.354    0.847
 Sweet gum    Sapling    0.844 0.130 2783    0.590    1.099
 Tulip poplar Sapling    1.517 0.342 2783    0.847    2.188
 Beech        Mature     0.701 0.125 2783    0.457    0.946
 Sweet gum    Mature     0.567 0.114 2783    0.344    0.790
 Tulip poplar Mature     1.588 0.120 2783    1.352    1.824

Results are given on the log (not the response) scale. 
Confidence level used: 0.95 

$contrasts
 contrast                                   estimate    SE   df t.ratio
 Beech Sapling - Sweet gum Sapling           -0.2439 0.143 2783  -1.703
 Beech Sapling - Tulip poplar Sapling        -0.9169 0.344 2783  -2.669
 Beech Sapling - Beech Mature                -0.1008 0.125 2783  -0.808
 Beech Sapling - Sweet gum Mature             0.0340 0.128 2783   0.267
 Beech Sapling - Tulip poplar Mature         -0.9874 0.137 2783  -7.207
 Sweet gum Sapling - Tulip poplar Sapling    -0.6730 0.348 2783  -1.931
 Sweet gum Sapling - Beech Mature             0.1431 0.143 2783   0.999
 Sweet gum Sapling - Sweet gum Mature         0.2779 0.128 2783   2.166
 Sweet gum Sapling - Tulip poplar Mature     -0.7435 0.134 2783  -5.547
 Tulip poplar Sapling - Beech Mature          0.8161 0.343 2783   2.378
 Tulip poplar Sapling - Sweet gum Mature      0.9509 0.342 2783   2.781
 Tulip poplar Sapling - Tulip poplar Mature  -0.0705 0.344 2783  -0.205
 Beech Mature - Sweet gum Mature              0.1348 0.126 2783   1.068
 Beech Mature - Tulip poplar Mature          -0.8866 0.136 2783  -6.539
 Sweet gum Mature - Tulip poplar Mature      -1.0214 0.120 2783  -8.494
 p.value
  0.5301
  0.0819
  0.9661
  0.9998
  <.0001
  0.3831
  0.9184
  0.2544
  <.0001
  0.1642
  0.0608
  1.0000
  0.8943
  <.0001
  <.0001

Results are given on the log (not the response) scale. 
P value adjustment: tukey method for comparing a family of 6 estimates 


non-normal model with seedling data and without sample period
**Model 1** -- Amy please rerun using damageJuly instead of damage2
```{r}

damageJuly$Percent_total_herbivory <- as.integer(as.numeric(damageJuly$Percent_total_herbivory))

#insectherbModeloverdisp2 <-glmmTMB(Percent_total_herbivory~ Species*Age_class+(1|plot_age_class/Plot/Tree_num), data = damage2, family = genpois)

insectherbModeloverdisp2 <-glmmTMB(Percent_total_herbivory~ Species*Age_class+(1|plot_age_class/Plot/Tree_num), data = damageJuly, family = genpois)

##model checking##
model_check2 <- simulateResiduals(insectherbModeloverdisp2)
plot(model_check2) #within-group deviations from uniformity significant, 
#Levene Test for homogeneity of variance signficant

testZeroInflation(insectherbModeloverdisp2) #not significant, good
testUniformity(insectherbModeloverdisp2) #not significant, good
testOutliers(insectherbModeloverdisp2) #not significant, good

drop1(insectherbModeloverdisp2, test = 'Chisq')
#Single term deletions

#Model:
#Percent_total_herbivory ~ Species * Age_class + (1 | plot_age_class/Plot/Tree_num)
#                  Df   AIC    LRT  Pr(>Chi)    
#<none>               10205                     
#Species:Age_class  4 10217 20.453 0.0004064 ***
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Anova(insectherbModeloverdisp2)

#Analysis of Deviance Table (Type II Wald chisquare tests)

#esponse: Percent_total_herbivory

#                    Chisq Df Pr(>Chisq)    
#Species            93.528  2  < 2.2e-16 ***
#Age_class         130.425  2  < 2.2e-16 ***
#Species:Age_class  16.502  4   0.002414 ** 
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

emmeans(insectherbModeloverdisp2, pairwise~as.factor(Species)*as.factor(Age_class), adjust="tukey")
```
$emmeans
 Species      Age_class emmean     SE   df lower.CL upper.CL
 Beech        Seedling  -0.527 0.2037 3436  -0.9268   -0.128
 Sweet gum    Seedling  -1.176 0.1880 3436  -1.5449   -0.808
 Tulip poplar Seedling  -1.831 0.5178 3436  -2.8466   -0.816
 Beech        Sapling    0.888 0.0979 3436   0.6961    1.080
 Sweet gum    Sapling    0.285 0.1173 3436   0.0554    0.515
 Tulip poplar Sapling   -0.122 0.4445 3436  -0.9933    0.750
 Beech        Mature     0.992 0.0974 3436   0.8010    1.183
 Sweet gum    Mature     0.172 0.0996 3436  -0.0233    0.367
 Tulip poplar Mature     1.130 0.0993 3436   0.9351    1.325

Results are given on the log (not the response) scale. 
Confidence level used: 0.95 

$contrasts
 contrast                                     estimate    SE   df t.ratio p.value
 Beech Seedling - Sweet gum Seedling             0.649 0.264 3436   2.458  0.2534
 Beech Seedling - Tulip poplar Seedling          1.304 0.550 3436   2.371  0.3003
 Beech Seedling - Beech Sapling                 -1.416 0.209 3436  -6.759  <.0001
 Beech Seedling - Sweet gum Sapling             -0.813 0.221 3436  -3.685  0.0072
 Beech Seedling - Tulip poplar Sapling          -0.406 0.482 3436  -0.843  0.9955
 Beech Seedling - Beech Mature                  -1.519 0.209 3436  -7.261  <.0001
 Beech Seedling - Sweet gum Mature              -0.699 0.213 3436  -3.282  0.0288
 Beech Seedling - Tulip poplar Mature           -1.657 0.216 3436  -7.683  <.0001
 Sweet gum Seedling - Tulip poplar Seedling      0.655 0.544 3436   1.205  0.9556
 Sweet gum Seedling - Beech Sapling             -2.064 0.197 3436 -10.481  <.0001
 Sweet gum Seedling - Sweet gum Sapling         -1.462 0.204 3436  -7.149  <.0001
 Sweet gum Seedling - Tulip poplar Sapling      -1.054 0.476 3436  -2.214  0.3963
 Sweet gum Seedling - Beech Mature              -2.168 0.197 3436 -10.994  <.0001
 Sweet gum Seedling - Sweet gum Mature          -1.348 0.196 3436  -6.863  <.0001
 Sweet gum Seedling - Tulip poplar Mature       -2.306 0.197 3436 -11.702  <.0001
 Tulip poplar Seedling - Beech Sapling          -2.719 0.521 3436  -5.219  <.0001
 Tulip poplar Seedling - Sweet gum Sapling      -2.117 0.524 3436  -4.040  0.0018
 Tulip poplar Seedling - Tulip poplar Sapling   -1.710 0.678 3436  -2.520  0.2224
 Tulip poplar Seedling - Beech Mature           -2.823 0.521 3436  -5.419  <.0001
 Tulip poplar Seedling - Sweet gum Mature       -2.003 0.521 3436  -3.844  0.0039
 Tulip poplar Seedling - Tulip poplar Mature    -2.961 0.521 3436  -5.683  <.0001
 Beech Sapling - Sweet gum Sapling               0.603 0.134 3436   4.504  0.0002
 Beech Sapling - Tulip poplar Sapling            1.010 0.448 3436   2.257  0.3691
 Beech Sapling - Beech Mature                   -0.104 0.112 3436  -0.926  0.9915
 Beech Sapling - Sweet gum Mature                0.716 0.117 3436   6.105  <.0001
 Beech Sapling - Tulip poplar Mature            -0.242 0.119 3436  -2.028  0.5239
 Sweet gum Sapling - Tulip poplar Sapling        0.407 0.453 3436   0.899  0.9931
 Sweet gum Sapling - Beech Mature               -0.707 0.134 3436  -5.260  <.0001
 Sweet gum Sapling - Sweet gum Mature            0.113 0.131 3436   0.866  0.9946
 Sweet gum Sapling - Tulip poplar Mature        -0.844 0.132 3436  -6.409  <.0001
 Tulip poplar Sapling - Beech Mature            -1.114 0.447 3436  -2.490  0.2370
 Tulip poplar Sapling - Sweet gum Mature        -0.294 0.448 3436  -0.655  0.9993
 Tulip poplar Sapling - Tulip poplar Mature     -1.252 0.448 3436  -2.792  0.1178
 Beech Mature - Sweet gum Mature                 0.820 0.117 3436   6.992  <.0001
 Beech Mature - Tulip poplar Mature             -0.138 0.118 3436  -1.164  0.9639
 Sweet gum Mature - Tulip poplar Mature         -0.958 0.116 3436  -8.224  <.0001

Results are given on the log (not the response) scale. 
P value adjustment: tukey method for comparing a family of 9 estimates 



###Microbial models###
**Model 2** -- Amy, please rerun using damageOct instead of damage1
```{r}
damageOct$Percent_microbial <- as.integer(as.numeric(damageOct$Percent_microbial))

#insectherbModeloverdisp3 <-glmmTMB(Percent_microbial~ Species*Age_class*Sample_period+(1|plot_age_class/Plot/Tree_num), data = damage1, family = genpois)

insectherbModeloverdisp3 <-glmmTMB(Percent_microbial~ Species*Age_class+(1|plot_age_class/Plot/Tree_num), data = damageOct, family = genpois)

##model checking##
model_check3 <- simulateResiduals(insectherbModeloverdisp3)
plot(model_check3) #KS test = deviation significant, might not be of concern? this is better than poisson distribution

#Amy also ran...#
testZeroInflation(insectherbModeloverdisp3) #not significant, good
testUniformity(insectherbModeloverdisp3) #not significant deviation
testOutliers(insectherbModeloverdisp3) #not significant, good

drop1(insectherbModeloverdisp3, test = 'Chisq')
#Single term deletions

#Model:
#Percent_microbial ~ Species * Age_class + (1 | plot_age_class/Plot/Tree_num)
#                  Df   AIC    LRT Pr(>Chi)
#<none>               16087                
#Species:Age_class  2 16086 3.1902   0.2029

Anova(insectherbModeloverdisp3)
#Analysis of Deviance Table (Type II Wald chisquare tests)

#Response: Percent_microbial
#                     Chisq Df Pr(>Chisq)    
#Species           122.2604  2     <2e-16 ***
#Age_class           0.7972  1     0.3719    
#Species:Age_class   3.1985  2     0.2020    
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

emmeans(insectherbModeloverdisp3, pairwise~as.factor(Species)*as.factor(Age_class), adjust="tukey")

```
Analysis of Deviance Table (Type II Wald chisquare tests)

Response: Percent_microbial
                     Chisq Df Pr(>Chisq)    
Species           122.2604  2     <2e-16 ***
Age_class           0.7972  1     0.3719    
Species:Age_class   3.1985  2     0.2020    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
> emmeans(insectherbModeloverdisp3, pairwise~as.factor(Species)*as.factor(Age_class), adjust="tukey")
$emmeans
 Species      Age_class emmean    SE   df lower.CL upper.CL
 Beech        Sapling     1.30 0.104 2783     1.09     1.50
 Sweet gum    Sapling     2.12 0.106 2783     1.91     2.33
 Tulip poplar Sapling     2.12 0.351 2783     1.43     2.81
 Beech        Mature      1.21 0.106 2783     1.00     1.42
 Sweet gum    Mature      2.33 0.086 2783     2.16     2.49
 Tulip poplar Mature      2.23 0.105 2783     2.02     2.43

Results are given on the log (not the response) scale. 
Confidence level used: 0.95 

$contrasts
 contrast                                   estimate    SE   df t.ratio p.value
 Beech Sapling - Sweet gum Sapling          -0.82131 0.130 2783  -6.319  <.0001
 Beech Sapling - Tulip poplar Sapling       -0.81927 0.358 2783  -2.289  0.1988
 Beech Sapling - Beech Mature                0.08780 0.121 2783   0.724  0.9790
 Beech Sapling - Sweet gum Mature           -1.02761 0.115 2783  -8.942  <.0001
 Beech Sapling - Tulip poplar Mature        -0.92824 0.131 2783  -7.104  <.0001
 Sweet gum Sapling - Tulip poplar Sapling    0.00204 0.360 2783   0.006  1.0000
 Sweet gum Sapling - Beech Mature            0.90911 0.132 2783   6.871  <.0001
 Sweet gum Sapling - Sweet gum Mature       -0.20630 0.113 2783  -1.830  0.4465
 Sweet gum Sapling - Tulip poplar Mature    -0.10694 0.127 2783  -0.842  0.9596
 Tulip poplar Sapling - Beech Mature         0.90707 0.358 2783   2.534  0.1146
 Tulip poplar Sapling - Sweet gum Mature    -0.20834 0.353 2783  -0.590  0.9918
 Tulip poplar Sapling - Tulip poplar Mature -0.10898 0.358 2783  -0.304  0.9997
 Beech Mature - Sweet gum Mature            -1.11541 0.116 2783  -9.583  <.0001
 Beech Mature - Tulip poplar Mature         -1.01604 0.132 2783  -7.685  <.0001
 Sweet gum Mature - Tulip poplar Mature      0.09937 0.110 2783   0.902  0.9461

Results are given on the log (not the response) scale. 
P value adjustment: tukey method for comparing a family of 6 estimates 

microbial models for seedlings without sampling period
**Model 1** -- Amy please rerun using damageJuly instead of damage2
```{r}
damageJuly$Percent_microbial <- as.integer(as.numeric(damageJuly$Percent_microbial))

#insectherbModeloverdisp4 <-glmmTMB(Percent_microbial~ Species*Age_class+(1|plot_age_class/Plot/Tree_num), data = damage2, family = genpois)

insectherbModeloverdisp4 <-glmmTMB(Percent_microbial~ Species*Age_class+(1|plot_age_class/Plot/Tree_num), data = damageJuly, family = genpois)

##model checking##
model_check4 <- simulateResiduals(insectherbModeloverdisp4)
plot(model_check4) #KS test: significant deviation
#within-group deviations from uniformity significant, 
#Levene Test for homogeneity of variance significant

testZeroInflation(insectherbModeloverdisp4) #not significant, good
testUniformity(insectherbModeloverdisp4) #significant deviation
testOutliers(insectherbModeloverdisp4) #not signfificant, good

drop1(insectherbModeloverdisp4, test = 'Chisq')
#Single term deletions

#Model:
#Percent_microbial ~ Species * Age_class + (1 | plot_age_class/Plot/Tree_num)
#                  Df   AIC    LRT  Pr(>Chi)    
#<none>               12092                     
#Species:Age_class  4 12193 109.58 < 2.2e-16 ***
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Anova(insectherbModeloverdisp4)

#Analysis of Deviance Table (Type II Wald chisquare tests)

#Response: Percent_microbial
#                    Chisq Df Pr(>Chisq)    
#Species           207.622  2  < 2.2e-16 ***
#Age_class          42.263  2  6.649e-10 ***
#Species:Age_class 123.895  4  < 2.2e-16 ***
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

emmeans(insectherbModeloverdisp4, pairwise~as.factor(Species)*as.factor(Age_class), adjust="tukey")
```

$emmeans
 Species      Age_class emmean     SE   df lower.CL upper.CL
 Beech        Seedling   0.242 0.1905 3436   -0.132   0.6153
 Sweet gum    Seedling  -0.336 0.1372 3436   -0.605  -0.0666
 Tulip poplar Seedling   0.654 0.2369 3436    0.190   1.1186
 Beech        Sapling   -1.043 0.1518 3436   -1.340  -0.7450
 Sweet gum    Sapling    1.177 0.1215 3436    0.939   1.4157
 Tulip poplar Sapling    1.728 0.4028 3436    0.938   2.5176
 Beech        Mature    -0.664 0.1434 3436   -0.945  -0.3827
 Sweet gum    Mature     1.207 0.0987 3436    1.013   1.4001
 Tulip poplar Mature     1.421 0.1168 3436    1.192   1.6501

Results are given on the log (not the response) scale. 
Confidence level used: 0.95 

$contrasts
 contrast                                     estimate    SE   df t.ratio p.value
 Beech Seedling - Sweet gum Seedling            0.5775 0.219 3436   2.636  0.1719
 Beech Seedling - Tulip poplar Seedling        -0.4123 0.290 3436  -1.421  0.8900
 Beech Seedling - Beech Sapling                 1.2844 0.219 3436   5.877  <.0001
 Beech Seedling - Sweet gum Sapling            -0.9356 0.216 3436  -4.340  0.0005
 Beech Seedling - Tulip poplar Sapling         -1.4859 0.441 3436  -3.369  0.0217
 Beech Seedling - Beech Mature                  0.9057 0.213 3436   4.244  0.0008
 Beech Seedling - Sweet gum Mature             -0.9647 0.208 3436  -4.643  0.0001
 Beech Seedling - Tulip poplar Mature          -1.1792 0.219 3436  -5.385  <.0001
 Sweet gum Seedling - Tulip poplar Seedling    -0.9898 0.261 3436  -3.785  0.0049
 Sweet gum Seedling - Beech Sapling             0.7069 0.188 3436   3.767  0.0053
 Sweet gum Seedling - Sweet gum Sapling        -1.5131 0.163 3436  -9.283  <.0001
 Sweet gum Seedling - Tulip poplar Sapling     -2.0634 0.420 3436  -4.908  <.0001
 Sweet gum Seedling - Beech Mature              0.3282 0.182 3436   1.799  0.6828
 Sweet gum Seedling - Sweet gum Mature         -1.5423 0.151 3436 -10.224  <.0001
 Sweet gum Seedling - Tulip poplar Mature      -1.7567 0.164 3436 -10.716  <.0001
 Tulip poplar Seedling - Beech Sapling          1.6967 0.268 3436   6.323  <.0001
 Tulip poplar Seedling - Sweet gum Sapling     -0.5233 0.256 3436  -2.047  0.5100
 Tulip poplar Seedling - Tulip poplar Sapling  -1.0736 0.463 3436  -2.320  0.3302
 Tulip poplar Seedling - Beech Mature           1.3180 0.263 3436   5.004  <.0001
 Tulip poplar Seedling - Sweet gum Mature      -0.5524 0.248 3436  -2.231  0.3855
 Tulip poplar Seedling - Tulip poplar Mature   -0.7669 0.255 3436  -3.003  0.0670
 Beech Sapling - Sweet gum Sapling             -2.2200 0.181 3436 -12.243  <.0001
 Beech Sapling - Tulip poplar Sapling          -2.7703 0.423 3436  -6.547  <.0001
 Beech Sapling - Beech Mature                  -0.3787 0.185 3436  -2.050  0.5083
 Beech Sapling - Sweet gum Mature              -2.2492 0.167 3436 -13.434  <.0001
 Beech Sapling - Tulip poplar Mature           -2.4636 0.179 3436 -13.739  <.0001
 Sweet gum Sapling - Tulip poplar Sapling      -0.5503 0.415 3436  -1.326  0.9237
 Sweet gum Sapling - Beech Mature               1.8413 0.176 3436  10.477  <.0001
 Sweet gum Sapling - Sweet gum Mature          -0.0291 0.135 3436  -0.215  1.0000
 Sweet gum Sapling - Tulip poplar Mature       -0.2436 0.149 3436  -1.639  0.7834
 Tulip poplar Sapling - Beech Mature            2.3916 0.420 3436   5.699  <.0001
 Tulip poplar Sapling - Sweet gum Mature        0.5211 0.408 3436   1.279  0.9376
 Tulip poplar Sapling - Tulip poplar Mature     0.3067 0.412 3436   0.745  0.9981
 Beech Mature - Sweet gum Mature               -1.8704 0.160 3436 -11.687  <.0001
 Beech Mature - Tulip poplar Mature            -2.0849 0.172 3436 -12.122  <.0001
 Sweet gum Mature - Tulip poplar Mature        -0.2145 0.130 3436  -1.646  0.7791

Results are given on the log (not the response) scale. 
P value adjustment: tukey method for comparing a family of 9 estimates 

graphs
```{r}


theme_set(theme_bw())
theme_update(axis.title.x=element_text(size=24, vjust=-0.35), axis.text.x=element_text(size=20, color = "black"),
             axis.title.y=element_text(size=24, angle=90, vjust=0.7), axis.text.y=element_text(size=20, color= "black"),
             plot.title = element_text(size=24, vjust=2),
             panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
             legend.title=element_blank(), legend.text=element_text(size=18), panel.border=element_rect(color="black", fill = NA, size = 1))

ggplot(data=barGraphStats(data=damage1, variable="Percent_total_herbivory", byFactorNames=c("Species", "Age_class")), aes(x=Species, y=mean, fill=Age_class)) +
  geom_bar(stat='identity', position=position_dodge()) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2, position=position_dodge(0.9))+
  theme(legend.title=element_blank())+
  theme_bw()+
  scale_fill_manual(values=c("darkolivegreen3", "darkolivegreen4"))+
  ylab('Mean Percent Herbivore Damage\n')+
  xlab(element_blank())+
  expand_limits(y=4) +
  annotate("text", x= 0.77, y = 3.5, label= "a", size = 6)+
  annotate("text", x= 1.23, y = 3.7, label= "a", size = 6)+
  annotate("text", x= 1.77, y = 2.7, label= "b", size = 6)+
  annotate("text", x= 2.23, y = 2.2, label= "b", size = 6)+
  annotate("text", x= 2.77, y = 3.4, label= "ab", size = 6)+
  annotate("text", x= 3.23, y = 3.8, label= "a", size = 6)+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  expand_limits(y=9)
```

###herbivory with seedlings###
```{r}
summary(insectherbModelseed <- lme(Percent_total_herbivory~Species*Age_class, data=damage2, random=~1|plot_age_class/Plot/Age_class/Tree_num, correlation=corCompSymm(form=~1|plot_age_class/Plot/Age_class/Tree_num), control=lmeControl(returnObject = T)))

anova.lme(insectherbModelseed, type = 'sequential')
emmeans(insectherbModelseed, pairwise~as.factor(Species)*as.factor(Age_class), adjust="tukey")
```


graphing with seedlings
```{r}
ggplot(data=barGraphStats(data=damage2, variable="Percent_total_herbivory", byFactorNames=c("Species", "Age_class")), aes(x=Species, y=mean, fill=Age_class)) +
  geom_bar(stat='identity', position=position_dodge()) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2, position=position_dodge(0.9))+
  theme(legend.title=element_blank())+
  theme_bw()+
  scale_fill_manual(values=c("darkolivegreen3", "darkolivegreen4", "darkolivegreen"))+
  ylab('Mean Percent Herbivore Damage\n')+
  xlab(element_blank())+
  expand_limits(y=4) +
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  expand_limits(y=9)

ggplot(data=barGraphStats(data=damage2, variable="Percent_total_herbivory", byFactorNames=c("Species", "Age_class")), aes(x=Species, y=mean, fill=Age_class)) +
  geom_bar(stat='identity', position=position_dodge()) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2, position=position_dodge(0.9))+
  theme(legend.title=element_blank())+
  theme_bw()+
  scale_fill_manual(values=c("darkolivegreen3", "darkolivegreen4", "darkolivegreen"))+
  ylab('Mean Percent Herbivore Damage\n')+
  xlab(element_blank())+
  expand_limits(y=4) +
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  expand_limits(y=9)+
  facet_wrap(~Sample_period)

```

#####Microbial model#########

```{r}
summary(microbialModel <-lme(Percent_microbial~as.factor(Species)*as.factor(Age_class)*as.factor(Sample_period), data=damage1, random=~1|plot_age_class/Plot, correlation=corCompSymm(form=~1|plot_age_class/Plot/plant_num), control=lmeControl(returnObject = T)))

anova.lme(microbialModel, type = 'sequential')
emmeans(microbialModel, pairwise~as.factor(Species)*as.factor(Age_class), adjust="tukey")
```

```{r}

ggplot(data=barGraphStats(data=damage1, variable="Percent_microbial", byFactorNames=c("Species", "Age_class")), aes(x=Species, y=mean, fill=Age_class)) +
  geom_bar(stat='identity', position=position_dodge()) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2, position=position_dodge(0.9))+
  theme_bw()+
  scale_fill_manual(values=c("darkolivegreen3", "darkolivegreen4"))+
  ylab('Mean Percent Microbial Damage\n')+
  xlab(element_blank())+
  annotate("text", x= 0.77, y = 2.7, label= "c", size = 6)+
  annotate("text", x= 1.23, y = 2.8, label= "c", size = 6)+
  annotate("text", x= 1.77, y = 7.9, label= "b", size = 6)+
  annotate("text", x= 2.23, y = 9.3, label= "a", size = 6)+
  annotate("text", x= 2.77, y = 9.5, label= "ab", size = 6)+
  annotate("text", x= 3.23, y = 8.7, label= "b", size = 6)+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  expand_limits(y=9)

```

graph with seedlings
```{r}
ggplot(data=barGraphStats(data=damage2, variable="Percent_microbial", byFactorNames=c("Species", "Age_class")), aes(x=Species, y=mean, fill=Age_class)) +
  geom_bar(stat='identity', position=position_dodge()) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2, position=position_dodge(0.9))+
  theme_bw()+
  scale_fill_manual(values=c("darkolivegreen3", "darkolivegreen4", "darkolivegreen"))+
  ylab('Mean Percent Microbial Damage\n')+
  xlab(element_blank())+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  expand_limits(y=9)
```

######Regressions###


practice regression graphs
```{r}
herbivory_lm <- lm(Percent_total_herbivory ~ plot_age*Species*Age_class*Sample_period, data = damage1)
summary(herbivory_lm)
#Age_class, sampling period

predictedherbivory <- predict(herbivory_lm, interval = "confidence", level = 0.95) 

full_herbivory <- data.frame(damage1, predictedherbivory)


ggplot(full_herbivory, aes(x = plot_age, y = Percent_total_herbivory))+
  geom_point(aes(color= Species))+
  geom_line(aes(x = plot_age, y = fit)) +
  geom_ribbon(aes(x = plot_age, ymin = lwr, ymax = upr), alpha = 0.3) +
  #annotate("text", x = 14, y = 290, label = "y = -7.35x + 161.33")+
  #annotate("text", x = 14, y = 270, label = "italic(R) ^ 2 == 0.14", parse = TRUE)+
  ylab('Percent herbivory')+
  xlab('Plot age')
 
ggplot(subset(damage1, Sample_period == 2 & Age_class == "Mature" & plot_age < 200), aes(x=plot_age, y=log10(Percent_total_herbivory))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("#D39200",  "#93AA00", "#00B9E3")) +
  geom_smooth(aes(color=Species, fill=Species), size=1, method=lm) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
  



number_ticks <- function(n) {function(limits) pretty(limits, n)}
sp.labs <- c("Jul", "Oct")
names(sp.labs) <- c("1", "2")

# Create the plot
#p + facet_grid(
  #dose ~ supp, 
 # labeller = labeller(dose = dose.labs, supp = supp.labs))

ggplot(damage1, aes(x=plot_age, y=log10(Percent_total_herbivory))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=1, method=lm) +
  scale_x_continuous(breaks=number_ticks(4)) +
  facet_grid(rows = vars(Age_class), cols = vars(Sample_period), labeller = labeller(Sample_period = sp.labs))+
  theme(strip.text.x = element_text(size = 14, color = "black"), strip.text.y = element_text(size = 14, color = "black"))+
  ylab("log10(Percent Herbivore Damage)")+
  xlab("Plot Age")+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())

ggplot(damage1, aes(x=plot_age, y=log10(Percent_microbial))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=1, method=lm) +
  scale_x_continuous(breaks=number_ticks(4)) +
  facet_grid(rows = vars(Age_class), cols = vars(Sample_period), labeller = labeller(Sample_period = sp.labs))+
  theme(strip.text.x = element_text(size = 14, color = "black"), strip.text.y = element_text(size = 14, color = "black"))+
  ylab("log10(Percent Microbial Damage)")+
  xlab("Plot Age")+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())



#mature, sample period 1
ggplot(subset(damage1, Sample_period == 1 & Age_class == "Mature"), aes(x=plot_age, y=log10(Percent_total_herbivory))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=0.5, method=lm) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

#mature sample period 2
ggplot(subset(damage1, Sample_period == 2 & Age_class == "Mature"), aes(x=plot_age, y=log10(Percent_total_herbivory))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=0.5, method=lm) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

#sapling sample period 1
ggplot(subset(damage1, Sample_period == 1 & Age_class == "Sapling"), aes(x=plot_age, y=log10(Percent_total_herbivory))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=1, method=lm) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

#sapling sample period 2
ggplot(subset(damage1, Sample_period == 2 & Age_class == "Sapling"), aes(x=plot_age, y=log10(Percent_total_herbivory))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=1, method=lm) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
```


####facet regression graphs####




```{r}
number_ticks <- function(n) {function(limits) pretty(limits, n)}
sp.labs <- c("Jul", "Oct")
names(sp.labs) <- c("1", "2")

# Create the plot
#p + facet_grid(
  #dose ~ supp, 
 # labeller = labeller(dose = dose.labs, supp = supp.labs))

ggplot(damage1, aes(x=plot_age, y=log10(Percent_total_herbivory))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=1, method=lm) +
  scale_x_continuous(breaks=number_ticks(4)) +
  facet_grid(rows = vars(Age_class), cols = vars(Sample_period), labeller = labeller(Sample_period = sp.labs))+
  theme(strip.text.x = element_text(size = 14, color = "black"), strip.text.y = element_text(size = 14, color = "black"))+
  ylab("log10(Percent Herbivore Damage)")+
  xlab("Plot Age")+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())

ggplot(damage1, aes(x=plot_age, y=log10(Percent_microbial))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=1, method=lm) +
  scale_x_continuous(breaks=number_ticks(4)) +
  facet_grid(rows = vars(Age_class), cols = vars(Sample_period), labeller = labeller(Sample_period = sp.labs))+
  theme(strip.text.x = element_text(size = 14, color = "black"), strip.text.y = element_text(size = 14, color = "black"))+
  ylab("log10(Percent Microbial Damage)")+
  xlab("Plot Age")+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())





ggplot(damage2, aes(x=plot_age, y=log10(Percent_total_herbivory))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=1, method=lm) +
  scale_x_continuous(breaks=number_ticks(4)) +
  facet_grid(rows = vars(Age_class), cols = vars(Sample_period), labeller = labeller(Sample_period = sp.labs))+
  theme(strip.text.x = element_text(size = 14, color = "black"), strip.text.y = element_text(size = 14, color = "black"))+
  ylab("log10(Percent Herbivore Damage)")+
  xlab("Plot Age")+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())

ggplot(damage2, aes(x=plot_age, y=log10(Percent_microbial))) +
  geom_point(aes(color=Species)) + 
  scale_color_manual(values = c("yellow3",  "chartreuse4", "darkorchid3")) +
  geom_smooth(aes(color=Species, fill=Species), size=1, method=lm) +
  scale_x_continuous(breaks=number_ticks(4)) +
  facet_grid(rows = vars(Age_class), cols = vars(Sample_period), labeller = labeller(Sample_period = sp.labs))+
  theme(strip.text.x = element_text(size = 14, color = "black"), strip.text.y = element_text(size = 14, color = "black"))+
  ylab("log10(Percent Microbial Damage)")+
  xlab("Plot Age")+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())

```
###add .001 to all values,using mutate new column 

####stacked bar charts#####

```{r}
herbivorywide <- damage1 %>%
  select (Plot, Species, Age_class, Leaf_num, Sample_period, Percent_chewed, Percent_mined, Percent_skeletonized, Percent_gall, plot_age, plot_age_class)

herbivorylong <- gather(herbivorywide, Herbivory_type, Percent_damage, Percent_chewed:Percent_gall, factor_key=TRUE)
herbivorylong

herbivorylong$Sample_period <- as.factor(herbivorylong$Sample_period)

ggplot(data=barGraphStats(data=herbivorylong, variable="Percent_damage", byFactorNames=c("Species", "Sample_period", "Herbivory_type")), aes(x=Sample_period, y=mean, fill=Herbivory_type))+
  geom_bar(position="stack", stat="identity")+
  facet_wrap(~Species)+
  ylab('Mean Percent Damage')+
  xlab('Sample Period')+
  theme(legend.title=element_blank())
  #facet_grid(rows = vars(Age_class), cols = vars(Species))

herbivorylongMature <- herbivorylong %>%
  filter(Age_class == "Mature")

ggplot(data=barGraphStats(data=herbivorylongMature, variable="Percent_damage", byFactorNames=c("Species", "Sample_period", "Herbivory_type")), aes(x=Sample_period, y=mean, fill=Herbivory_type))+
  geom_bar(position="stack", stat="identity")+
  scale_fill_discrete(labels = c("Chewing", "Mining", "Skeletonizing", "Galls"))+
  facet_wrap(~Species)+
  theme(strip.text.x = element_text(size = 14, color = "black"))+
  ylab('Mean Percent Herivore Damage on Mature Trees\n')+
  xlab('Sample Period')+
  theme(legend.title=element_blank())+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  scale_x_discrete(labels = c("Jul", "Oct"))

herbivorylongSapling <- herbivorylong %>%
  filter(Age_class == "Sapling")

ggplot(data=barGraphStats(data=herbivorylongSapling, variable="Percent_damage", byFactorNames=c("Species", "Sample_period", "Herbivory_type")), aes(x=Sample_period, y=mean, fill=Herbivory_type))+
  geom_bar(position="stack", stat="identity", width = 1)+
  scale_fill_discrete(labels = c("Chewing", "Mining", "Skeletonizing", "Galls"))+
  facet_wrap(~Species)+
  theme(strip.text.x = element_text(size = 14, color = "black"))+
  ylab('Mean Percent Herbivore Damage on Saplings\n')+
  xlab('Sample Period')+
  theme(legend.title=element_blank())+
  theme(legend.title=element_blank())+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  scale_x_discrete(labels = c("Jul", "Oct"))

damage1$Sample_period <- as.factor(damage1$Sample_period)

ggplot(data=barGraphStats(data=damage1, variable = "Percent_microbial", byFactorNames=c("Species", "Sample_period")), aes(x=Sample_period, y=mean))+
  geom_bar(position="dodge", stat="identity")+
  facet_wrap(~Species)+
  ylab('Mean Percent Microbial Damage')+
  xlab('Sample Period')


ggplot(data=barGraphStats(data=damageMature, variable = "Percent_microbial", byFactorNames=c("Species", "Sample_period")), aes(x=Sample_period, y=mean))+
  geom_bar(position="dodge", stat="identity",  fill="chocolate2")+
  facet_wrap(~Species)+
  theme(strip.text.x = element_text(size = 14, color = "black"))+
  ylab('Mean Percent Microbial Damage on Mature Trees\n')+
  xlab('Sample Period')+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  scale_x_discrete(labels = c("Jul", "Oct"))+
  expand_limits(y=15)

ggplot(data=barGraphStats(data=damageSapling, variable = "Percent_microbial", byFactorNames=c("Species", "Sample_period")), aes(x=Sample_period, y=mean))+
  geom_bar(position="dodge", stat="identity", fill="chocolate2")+
  facet_wrap(~Species)+
  theme(strip.text.x = element_text(size = 14, color = "black"))+
  ylab('Mean Percent Microbial Damage\n')+
  xlab('Sample Period')+
  theme(legend.title=element_blank())+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  scale_x_discrete(labels = c("Jul", "Oct"))+
  expand_limits(y=15)

```


stacked graphs for seedlings
```{r}

herbivorywideSeedlings <- damage2 %>%
  select (Plot, Species, Age_class, Leaf_num, Sample_period, Percent_chewed, Percent_mined, Percent_skeletonized, Percent_gall, plot_age, plot_age_class)

herbivorylongSeedlings <- gather(herbivorywideSeedlings, Herbivory_type, Percent_damage, Percent_chewed:Percent_gall, factor_key=TRUE)
herbivorylong

herbivorylongSeedlings$Sample_period <- as.factor(herbivorylongSeedlings$Sample_period)

herbivorylongSeedlingsSeed <- herbivorylongSeedlings%>%
  filter(Age_class == "Seedling")

ggplot(data=barGraphStats(data=herbivorylongSeedlingsSeed, variable="Percent_damage", byFactorNames=c("Species", "Sample_period", "Herbivory_type")), aes(x=Sample_period, y=mean, fill=Herbivory_type))+
  geom_bar(position="stack", stat="identity")+
  scale_fill_discrete(labels = c("Chewing", "Mining", "Skeletonizing", "Galls"))+
  facet_wrap(~Species)+
  theme(strip.text.x = element_text(size = 14, color = "black"))+
  ylab('Mean Percent Herivore Damage\n')+
  xlab('Sample Period')+
  theme(legend.title=element_blank())+
  theme(legend.title=element_blank(),legend.text=element_text(size=16), axis.text.x=element_text(size=16, color = "black"), axis.title.y=element_text(size=18), axis.text.y=element_text(size=16, color= "black"), axis.title.x=element_text(size=18), panel.grid.major=element_blank(), panel.grid.minor=element_blank())+
  scale_x_discrete(labels = c("Jul", "Oct"))
```

######original code from Kim####
```{r}
##code from Kim below
#below is the model
summary(insectherbModel <- lme(avg_perc_herbivory~as.factor(species)*as.factor(ind_age)*as.factor(stand_age), #typical model with percent herbivory as a dependent variable and species, individual age, and stand age as explanatory variables
                               data=herbivoryData, #the dataframe the model is being run on
                               random=~1|plot, #random statement for which plot the plant came from
                               correlation=corCompSymm(form=~date|plot/plant), #compound symmetry correlation structure (good for herbivory, which isn't necessarily increasing through time), saying that plants are nested within plots, which were sampled multiple dates
                               control=lmeControl(returnObject=T))) #I forget what this does, but I think it is important to keep

#this checks that the model ran ok (checks assumptions, might not work exactly right on this model though)
check_model(insectherbModel)

#this gives you your p-values
anova.lme(insectherbModel, type='sequential') 


#this gives you the mean and standard errors for each treatment
emmeans(insectherbModel, pairwise~as.factor(stand_age), adjust="tukey")




#same model with a sqrt transformation to make the data normal
summary(insectherbModel <- lme(sqrt(avg_perc_herbivory)~as.factor(species)*as.factor(ind_age)*as.factor(stand_age), #note how avg_perc_herbivory is square root transformed in this one
                               data=herbivoryData, 
                               random=~1|plot, 
                               correlation=corCompSymm(form=~date|plot/plant),
                               control=lmeControl(returnObject=T)))
check_model(insectherbModel)
anova.lme(insectherbModel, type='sequential') 
back.emmeans(emmeans(insectherbModel, pairwise~as.factor(stand_age), adjust="tukey"), transform='sqrt') #back.emmeans will backtransform the values for you 
```

